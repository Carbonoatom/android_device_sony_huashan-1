From be6b9dfb17c8aaedaaa4d34c71f614a2bead67bf Mon Sep 17 00:00:00 2001
From: neXusPRIME <yasir.elec@gmail.com>
Date: Tue, 29 Jul 2014 11:47:06 +0500
Subject: [PATCH] Use releasetools patch for LBL scripts

Change-Id: If239928adb33c1825702487cc24f9b876b352e7f
---
 tools/releasetools/edify_generator.py    | 10 ++++++++++
 tools/releasetools/ota_from_target_files |  6 ++++--
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/tools/releasetools/edify_generator.py b/tools/releasetools/edify_generator.py
index de82455..9e39dfb 100644
--- a/tools/releasetools/edify_generator.py
+++ b/tools/releasetools/edify_generator.py
@@ -133,6 +133,16 @@ class EdifyGenerator(object):
         ## Hax: a failure from run_program doesn't trigger an abort, so have it change the key value and check for "INVALID"
         self.script.append('sha1_check(read_file("/tmp/releasekey"),"7241e92725436afc79389d4fc2333a2aa8c20230") && abort("Can\'t install this package on top of incompatible data. Please try another package or run a factory reset");')
 
+  def WIFImac(self, macsymlinks):
+    self.script.append('symlink("/data/etc/wlan_macaddr0", "/system/etc/firmware/wlan/macaddr0");')
+    self.script.append('symlink("/data/etc/wlan_macaddr1", "/system/etc/firmware/wlan/macaddr1");')
+    self.script.append('symlink("/data/etc/wlan_macaddr2", "/system/etc/firmware/wlan/macaddr2");')
+    self.script.append('symlink("/data/etc/wlan_macaddr3", "/system/etc/firmware/wlan/macaddr3");')
+
+  def LBLperm(self, customstrings):
+    self.script.append('set_metadata("/system/bin/hijack.tar", "uid", 0, "gid", 0, "mode", 0777, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");')
+    self.script.append('set_metadata("/system/bin/wipedata", "uid", 0, "gid", 0, "mode", 0777, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");')
+
   def ShowProgress(self, frac, dur):
     """Update the progress bar, advancing it over 'frac' over the next
     'dur' seconds.  'dur' may be zero to advance it via SetProgress
diff --git a/tools/releasetools/ota_from_target_files b/tools/releasetools/ota_from_target_files
index d0f8b3c..90836cd 100755
--- a/tools/releasetools/ota_from_target_files
+++ b/tools/releasetools/ota_from_target_files
@@ -534,6 +534,7 @@ else if get_stage("%(bcb_dev)s", "stage") == "3/3" then
     script.UnpackPackageDir("recovery", "/system")
   script.UnpackPackageDir("system", "/system")
 
+  script.WIFImac("macsymlinks")
   symlinks = CopySystemFiles(input_zip, output_zip)
   script.MakeSymlinks(symlinks)
 
@@ -544,6 +545,7 @@ else if get_stage("%(bcb_dev)s", "stage") == "3/3" then
 
   Item.GetMetadata(input_zip)
   Item.Get("system").SetPermissions(script)
+  script.LBLperm("customstrings")
 
   common.CheckSize(boot_img.data, "boot.img", OPTIONS.info_dict)
   common.ZipWriteStr(output_zip, "boot.img", boot_img.data)
@@ -555,8 +557,8 @@ else if get_stage("%(bcb_dev)s", "stage") == "3/3" then
     script.ShowProgress(0.2, 10)
     script.RunBackup("restore")
 
-  script.ShowProgress(0.2, 10)
-  script.WriteRawImage("/boot", "boot.img")
+  #script.ShowProgress(0.2, 10)
+  #script.WriteRawImage("/boot", "boot.img")
 
   script.ShowProgress(0.1, 0)
   device_specific.FullOTA_InstallEnd()
-- 
1.9.1

