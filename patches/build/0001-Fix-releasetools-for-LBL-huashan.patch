From e7a3d7c2c016f3d10d29c6f636f8361e90dd0972 Mon Sep 17 00:00:00 2001
From: neXusPRIME <yasir.elec@gmail.com>
Date: Wed, 13 Aug 2014 18:02:41 +0500
Subject: [PATCH] Fix releasetools for LBL huashan

Change-Id: I68425a886db3c8219fd03e2f7b1f6424119b7a20
---
 tools/releasetools/edify_generator.py    | 10 ++++++++++
 tools/releasetools/ota_from_target_files |  8 +++++---
 2 files changed, 15 insertions(+), 3 deletions(-)

diff --git a/tools/releasetools/edify_generator.py b/tools/releasetools/edify_generator.py
index de82455..9e39dfb 100644
--- a/tools/releasetools/edify_generator.py
+++ b/tools/releasetools/edify_generator.py
@@ -133,6 +133,16 @@ class EdifyGenerator(object):
         ## Hax: a failure from run_program doesn't trigger an abort, so have it change the key value and check for "INVALID"
         self.script.append('sha1_check(read_file("/tmp/releasekey"),"7241e92725436afc79389d4fc2333a2aa8c20230") && abort("Can\'t install this package on top of incompatible data. Please try another package or run a factory reset");')
 
+  def WIFImac(self, macsymlinks):
+    self.script.append('symlink("/data/etc/wlan_macaddr0", "/system/etc/firmware/wlan/macaddr0");')
+    self.script.append('symlink("/data/etc/wlan_macaddr1", "/system/etc/firmware/wlan/macaddr1");')
+    self.script.append('symlink("/data/etc/wlan_macaddr2", "/system/etc/firmware/wlan/macaddr2");')
+    self.script.append('symlink("/data/etc/wlan_macaddr3", "/system/etc/firmware/wlan/macaddr3");')
+
+  def LBLperm(self, customstrings):
+    self.script.append('set_metadata("/system/bin/hijack.tar", "uid", 0, "gid", 0, "mode", 0777, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");')
+    self.script.append('set_metadata("/system/bin/wipedata", "uid", 0, "gid", 0, "mode", 0777, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");')
+
   def ShowProgress(self, frac, dur):
     """Update the progress bar, advancing it over 'frac' over the next
     'dur' seconds.  'dur' may be zero to advance it via SetProgress
diff --git a/tools/releasetools/ota_from_target_files b/tools/releasetools/ota_from_target_files
index 43210a8..cfeb9e6 100755
--- a/tools/releasetools/ota_from_target_files
+++ b/tools/releasetools/ota_from_target_files
@@ -555,6 +555,7 @@ else if get_stage("%(bcb_dev)s", "stage") == "3/3" then
   script.Print("Extracting system files...")
   script.UnpackPackageDir("system", "/system")
 
+  script.WIFImac("macsymlinks")
   symlinks = CopySystemFiles(input_zip, output_zip)
   script.Print("Making symlinks")
   script.MakeSymlinks(symlinks)
@@ -566,6 +567,7 @@ else if get_stage("%(bcb_dev)s", "stage") == "3/3" then
 
   Item.GetMetadata(input_zip)
   Item.Get("system").SetPermissions(script)
+  script.LBLperm("customstrings")
 
   common.CheckSize(boot_img.data, "boot.img", OPTIONS.info_dict)
   common.ZipWriteStr(output_zip, "boot.img", boot_img.data)
@@ -577,9 +579,9 @@ else if get_stage("%(bcb_dev)s", "stage") == "3/3" then
     script.ShowProgress(0.2, 10)
     script.RunBackup("restore")
 
-  script.ShowProgress(0.2, 10)
-  script.Print("Flashing boot.img")
-  script.WriteRawImage("/boot", "boot.img")
+  #script.ShowProgress(0.2, 10)
+  #script.Print("Flashing boot.img")
+  #script.WriteRawImage("/boot", "boot.img")
 
   script.ShowProgress(0.1, 0)
   script.Print("Thanks for choosing PAC-ROMS")
-- 
1.9.1

